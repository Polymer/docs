<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/context-free-parser/context-free-parser.html">
<link rel="import" href="../components/core-collapse/core-collapse.html">
<link rel="import" href="../components/marked-element/marked-element.html">
<!-- <link rel="import" href="../components/highlightjs-element/highlightjs-element.html"> -->

<polymer-element name="component-docs" attributes="elements">
  <template>
    <context-free-parser url="{{url}}" data="{{fetchedData}}">
    </context-free-parser>
    <template repeat="{{c in data.classes}}">
      <doc-page id="{{c.name}}" name="{{c.name}}" data="{{c}}"
                downloadable?="{{ isTopLevelElement(c.name, url) }}"
                on-show-inherited="{{handleShowInherited}}">
      </doc-page>
    </template>
  </template>
  <script>
    Polymer('component-docs', {
      elementName: null,
      url: null,
      elements: {},
      updateElementFromHash: function() {
        // Make sure we've trashed the previous element
        this.data = null;
        var elementName = window.location.hash.slice(1);
        if (this.elementName !== elementName && this.elements[elementName]) {
          this.elementName = elementName;
        }
      },
      ready: function() {
        this.updateElementFromHash();
        window.addEventListener('hashchange', this.updateElementFromHash.bind(this));
      },
      elementNameChanged: function() {
        this.url = '/' + this.elements[this.elementName];
        window.location.hash = this.elementName;
      },
      fetchedDataChanged: function(oldData, newData) {
        // A hash change has occurred and we're fetching
        // a new element
        if (!this.data) {
          this.data = newData;

        // Otherwise, element data already exists and we're
        // recursively fetching the elements it extends from
        } else {
          // Create a list of elements that we extend from
          var el = this.data.classes[0];
          el.extended = this.data.classes[0].extended || [];
          // It's possible to stuff multiple element definitions into a single
          // file, though typically we do one per file.
          // This grabs the first definition, assuming it's the only one, and
          // adds it to our list of extended elements
          var extendedEl = newData.classes[0];
          el.extended.push(extendedEl);
          // If the element we're extending from also extends another element,
          // repeat the above process to add it to the list
          if (extendedEl.extends) {
            this.fetchInherited(extendedEl.extends);
          }
        }

        // If we didn't find any documentation for our element...
        if (el.name === 'Entity') {
          el.name = this.elementName;
        }
      },
      isTopLevelElement: function(name, url) {
        return url.indexOf('/components/' + name + '/') == 0;
      },
      handleShowInherited: function(e, detail) {
        if (this.data.classes[0].extended) {
          return;
        }

        this.fetchInherited(detail.name);
      },
      fetchInherited: function(name) {
        this.url = '/components/' + name + '/' + name + '.html';
      }
    });
  </script>
</polymer-element>

<polymer-element name="doc-page" attributes="data downloadable" assetpath="../core-doc-viewer/elements/">
  <template>
    <link rel="stylesheet" href="../components/highlightjs/styles/default.css">
    <link rel="stylesheet" href="../css/elements/doc-page.css">
    <div class="main" on-marked-js-highlight="{{prettyPrint}}">
      <h1>{{data.name}}</h1>

      <template if="{{data.extends}}">
        <section class="top">
          <h3>Extends: <a href="{{data.extends | collectionPrefix}}-elements.html#{{data.extends}}">{{data.extends}}</a></h3>
        </section>
      </template>

      <template if="{{downloadable}}">
        <p>
          <component-download-button id="downloadButton"
              org="Polymer" component="{{data.name}}"
              label="Get {{data.name}}"></component-download-button>
          <a class="badge" target="_blank" href="/components/{{data.name}}/demo.html" on-click="{{recordDemoPageview}}">
            <paper-button label="Demo" raisedButton></paper-button>
          </a>
        </p>
      </template>

      <template if="{{data.description}}">
        <section class="box top">
          <h3>Summary</h3>
          <marked-element text="{{data.description}}"></marked-element>
        </section>
      </template>

      <detail-list kind="attributes" data="{{data}}"></detail-list>
      <detail-list kind="properties" data="{{data}}"></detail-list>
      <detail-list kind="events" data="{{data}}"></detail-list>
      <detail-list kind="methods" data="{{data}}"></detail-list>

    </div>
  </template>
  <script>
  (function() {
    function encodeHTMLEntities_(htmlStr) {
      return htmlStr.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    Polymer('doc-page', {
      downloadable: false,
      recordDemoPageview: function(e, detail, sender) {
        window.recordPageview && window.recordPageview(sender.href); // global pollution.
      },
      prettyPrint: function(e, detail, sender) {
        if (window.prettyPrintOne) {
          detail.code = window.prettyPrintOne(encodeHTMLEntities_(detail.code));
        }
      },
      collectionPrefix: function(elementName) {
        var match = elementName.match(/(\w+)-/);
        return match ? match[1] : 'core';
      }
    });

  })();
  </script>
</polymer-element>

<polymer-element name="detail-list" attributes="kind data">
  <template>
    <link rel="stylesheet" href="../css/elements/detail-list.css">
    <template if="{{data[kind].length || data.extends}}">
      <section class="box">
        <h3>{{kind | titleCase}}</h3>
        <template if="{{data.extends}}">
          <a id="toggle" href="#" on-click="{{toggleCollapse}}">
            Show inherited
          </a>
        </template>
        
        <core-collapse id="collapse">
          <template repeat="{{element in data.extended}}">
            <template if="{{!element[kind].length}}">
              <detail-item inherited></detail-item>
            </template>
            <template repeat="{{entity in element[kind]}}">
              <detail-item inherited data="{{entity}}">
              </detail-item>
            </template>
          </template>
        </core-collapse>

        <template repeat="{{entity in data[kind]}}">
          <detail-item data="{{entity}}"></detail-item>
        </template>
      </section>
    </template>
  </template>
  <script>
    Polymer({
      titleCase: function(str) {
        return str.charAt(0).toUpperCase() + str.substr(1).toLowerCase();
      },
      toggleCollapse: function(e) {
        e.preventDefault();
        this.fire('show-inherited', { name: this.data.extends });
        this.$.collapse.toggle();
      }
    });
  </script>
</polymer-element>

<polymer-element name="detail-item" attributes="data" horizontal layout>
  <template>
    <link rel="stylesheet" href="../css/elements/detail-item.css">
    <template bind="{{data}}">
      <div class="details-name" flex>
        <p><code>{{name || '(None)'}}</code></p>
      </div>
      <div class="details-info" flex three>
        <template if="{{kind == 'attribute' || kind == 'property'}}">
          <p layout horizontal center justified>
            <code>{{type}}</code><span class="default" hidden?="{{!default}}">default: <code>{{default}}</code></span>
          </p>
        </template>
        <marked-element text="{{description}}"></marked-element>
        <template if="{{kind == 'event' || kind == 'method'}}">
          <template if="{{params.length}}">
            <div class="params">
              <p>Params:</p>
              <template repeat="{{params}}">
                <p><code>{{name}}</code><span> <code>( {{type}} )</code></span></p>
                <p><span>{{description}}</span></p>
              </template>
            </div>
          </template>
        </template>
      </div>
    </template>
  </template>
  <script>
    Polymer({
      data: {}
    });
  </script>
</polymer-element>
